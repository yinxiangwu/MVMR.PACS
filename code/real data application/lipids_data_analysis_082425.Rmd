---
title: "real_data_app_32lipids"
author: "Yinxiang"
date: "2024-07-19"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
library(magrittr)
library(mr.divw)
library(corrplot)
library(BDcocolasso)
library(glmnet)
library(MVMR)
library(datathin)
library(MVMRcMLSuSiE)
library(MRcML)
library(MVMRcML)
library(doParallel)
library(foreach)
link_to_my_funs <- '~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/manuscript/code/my functions/'
source(paste0(link_to_my_funs,'mvMR_glmnet.R'))
source(paste0(link_to_my_funs,'PACS_funs_0629.R'))
source(paste0(link_to_my_funs,"summary_mvMR_BF.R"))
source(paste0(link_to_my_funs,"summary_mvMR_SSS.R"))
tmp <- read.csv('data/lipids_processed_data/lipids_total32_5e-08.csv')
P <- read.csv('data/lipids_processed_data/lipids_total32_5e-08_cor_mat.csv')[1:32,1:32] %>% as.matrix(.)
traits <- c('XS-VLDL-PL','XS-VLDL-L','LDL-D','L-LDL-PL','L-LDL-P',
            'L-LDL-L','L-LDL-FC','L-LDL-C','L-LDL-CE','M-LDL-P',
            'M-LDL-L','M-LDL-CE','S-LDL-P','S-LDL-L','S-LDL-C',
            'IDL-L','IDL-FC','IDL-C','HDL-D','XL-HDL-TG',
            'L-HDL-PL','M-HDL-PL','M-HDL-P','M-HDL-L','M-HDL-CE',
            'S-HDL-P','S-HDL-L','ApoA1','ApoB','HDL-C','LDL-C','TG')
```

We apply MVMR-PACS and DT-PACS-adIVW to 32 lipids (19 subfractions and 5 traditional lipid traits).

```{r, include=FALSE}
beta.exposure <- tmp[,paste0('gamma_exp',1:32)] %>% as.matrix(.)
se.exposure <- tmp[,paste0('se_exp',1:32)] %>% as.matrix(.)
beta.outcome <- tmp$gamma_out1
se.outcome <- tmp$se_out1
p <- nrow(beta.exposure)
K <- 32
rr_choice <- 0.8
```

When p-value threshold is $5\times 10^{-8}$, 114 SNPs are included. IV strength parameter is -6.2 and conditional F-stats are: 

```{r, include=TRUE}
F.data <- format_mvmr(BXGs = beta.exposure,
                            BYG = beta.outcome,
                            seBXGs = se.exposure,
                            seBYG = se.outcome,
                            RSID = tmp$SNP)
fres <- strength_mvmr(r_input = F.data, gencov = lapply(1:p, function(j) 
  {diag(se.exposure[j,]) %*% P %*% diag(se.exposure[j,]) }))
      
F_hist <- as.numeric(fres)
names(F_hist) <- traits
print(F_hist)
```

The correlation of beta.exposure of the 32 exposures is shown in the figure below, which is very similar to Qingyuan's paper, though they reported genetic correlations.

```{r,include=TRUE}
cor_mat <- cor(beta.exposure)
rownames(cor_mat) <- traits
colnames(cor_mat) <- traits
jpeg("~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/manuscript/code/Res/fig 5e-08/lipids32_cor_mat.jpeg",height = 4000, width = 4000, res = 600)
corrplot(cor_mat,order = 'hclust')
dev.off()
```

```{r, include=FALSE, warning=FALSE}
set.seed(1234)
ivw.obj <- mvmr.ivw(beta.exposure,se.exposure = se.exposure,beta.outcome = beta.outcome,se.outcome = se.outcome,gen_cor = P)
ivw.res <- ivw.obj$beta.hat

srivw.obj <- mvmr.srivw(beta.exposure,se.exposure = se.exposure,beta.outcome = beta.outcome,se.outcome = se.outcome,gen_cor = P,phi_cand = NULL)
srivw.res <- srivw.obj$beta.hat

ivw_lasso_input=new("mvMRInput", betaX = as.matrix(beta.exposure/se.outcome), betaY = as.matrix(beta.outcome/se.outcome), snps=as.character(1:p), exposure=as.character(1:K))
      
lasso=glmnet_l1_mr(ivw_lasso_input, cv=TRUE)			
      
beta.lasso.res <- lasso@Estimate

eps <- 1e-4

betawt <- obtain_initial(beta.exposure,se.exposure,beta.outcome,se.outcome,iv_strength_parameter = ivw.obj$iv_strength_parameter,P = P,epsilon = eps, n_times = 5, lambda.1se = TRUE, seed = 1234, lambda.length = 30)
round(betawt,3)

# dIVW + LASSO penalty

dlasso <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 3, RR_obs = cor(beta.exposure), rr_cut_off = 1, betawt = betawt, tau = c(0.5, 1, 2, 3), eps = eps, n_times = 5,lambda.1se = TRUE, lambda.length = 30, seed = 1234)

beta.lasso.divw.res <- dlasso$beta

pacs_0.2 <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 4, RR_obs = cor(beta.exposure), rr_cut_off = 0.2, betawt = betawt, tau = c(0.5, 1, 2, 3), eps = eps, n_times = 5,lambda.1se = TRUE,lambda.length = 30, seed = 1234)

beta.pacs4.0.2.res <- pacs_0.2$beta

pacs_0.5 <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 4, RR_obs = cor(beta.exposure), rr_cut_off = 0.5, betawt = betawt, tau = c(0.5, 1, 2, 3), eps = eps, n_times = 5,lambda.1se = TRUE,lambda.length = 30, seed = 1234)

beta.pacs4.0.5.res <- pacs_0.5$beta

pacs_0.8 <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 4, RR_obs = cor(beta.exposure), rr_cut_off = 0.8, betawt = betawt, tau = c(0.5, 1, 2, 3), eps = eps, n_times = 5, lambda.1se = TRUE,lambda.length = 30, seed = 1234)

beta.pacs4.0.8.res <- pacs_0.8$beta

pacs4_v2 <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 2, RR_obs = cor(beta.exposure), betawt = betawt, tau = c(0.5, 1, 2, 3), eps = eps, n_times = 5, seed = 1234, lambda.length = 30, lambda.1se = TRUE)

beta.pacs4_v2.res <- pacs4_v2$beta

# MRMBA
betaX_ivw = beta.exposure / se.outcome
betaY_ivw = beta.outcome / se.outcome
    
mrbma_input=new("mvMRInput", betaX = as.matrix(betaX_ivw), betaY = as.matrix(betaY_ivw), snps=as.character(1:p), exposure=as.character(1:K), outcome = "amd")
BMA_output=summarymvMR_SSS(mrbma_input,prior_prob=0.5, max_iter=10000)
mr.bma.out = sss.report.mr.bma(BMA_output, top = 32, write.out = FALSE)
beta.mrbma.res <- as.numeric(mr.bma.out[order(as.numeric(mr.bma.out[,1])),3])
# marginal inclusion probability
mr.bma.out = sss.report.mr.bma(BMA_output, top = 32, write.out = FALSE)
mr.bma.out[,1] <- traits[as.numeric(mr.bma.out[,1])]
# write.csv(mr.bma.out,'~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/manuscript/table figure/supp_mrbma_mip.csv',row.names = FALSE)


# MVMR-cML-SuSiE
exposure.pval <- 2 * pnorm(abs(beta.exposure/se.exposure),lower.tail = FALSE)
outcome.pval <- 2 * pnorm(abs(beta.outcome/se.outcome),lower.tail = FALSE)
sample.size.vec <- c(rep(115082,27),rep(439214,2),rep(1.32*1e6,3))
mvdat <- NULL
mvdat$exposure_beta <- beta.exposure
mvdat$exposure_pval <- exposure.pval
mvdat$exposure_se <- se.exposure
mvdat$outcome_beta <- beta.outcome
mvdat$outcome_pval <- outcome.pval
mvdat$outcome_se <- se.outcome
mvdat$expname <- paste0('gamma_exp',1:32)
mvdat$outname <- 'CAD'

theta.vec <- rep(NA,32)
for (j in 1:32) {
  theta.vec[j] <- mr_cML(as.vector(beta.exposure[,j]),beta.outcome[j],as.vector(se.exposure[j,]),se.outcome[j],n = sample.size.vec[j],random_seed = 1234)$MA_BIC_theta
}

P.mat <- read.csv('~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/real_data_app/lipids_processed_data/lipids_total32_5e-08_cor_mat.csv') %>% as.matrix(.)
step3.res <- mvmr.cml.susie.step3(mvdat, invalid.idx = NULL, theta.vec, rho.mat = P.mat)

which(step3.res$alpha[1,] > 1/32)
which(step3.res$alpha[2,] > 1/32)
which(step3.res$alpha[3,] > 1/32)
which(step3.res$alpha[4,] > 1/32)

mvmr.cml.res <- matrix(NA, nrow = 8 * 4, ncol = 3)

susie.groups <- c('14-22-31-32','14-23-31-32','14-24-31-32','14-28-31-32',
         '15-22-31-32','15-23-31-32','15-24-31-32','15-28-31-32')

mvmr.cml.res[,1] <- rep(susie.groups,each = 4)
mvmr.cml.res[,2] <- rep(1:4,8)

for (l in 1:8) {
  
  index.set1 <- as.numeric(unlist(strsplit(susie.groups[l], "-")))
  
  Sig.inv.l.sub1 <- invcov_mvmr(se_bx = as.matrix(se.exposure[,index.set1]),
                         se_by = se.outcome,
                         rho_mat = P.mat[c(index.set1,33),c(index.set1,33)])

  n <- min(sample.size.vec[index.set1])

  MVcML.res.sub1 <- MVmr_cML(b_exp = as.matrix(beta.exposure[,index.set1]),
                         b_out = as.matrix(beta.outcome),
                         se_bx = as.matrix(se.exposure[,index.set1]),
                         Sig_inv_l = Sig.inv.l.sub1, n = n,
                         K_vec = 0:(p-3))

  mvmr.cml.res[(1+(l-1)*4):(4*l),3] <- MVcML.res.sub1$BIC_theta

}

write.csv(mvmr.cml.res,'~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/manuscript/table figure/supp_mvmr_cml_res.csv',row.names = FALSE)
```

The results from different estimators are summarized in the table below. No data thinning is involved in this analysis. For MVMR-PACS3 and MVMR-PACS4, I used cut-off of 0.8 for correlations.

```{r, include=TRUE}
tbl_res <- rbind(ivw.res[,1], srivw.res[,1], beta.lasso.res, beta.lasso.divw.res,
                 beta.pacs4.0.2.res,beta.pacs4.0.5.res,beta.pacs4.0.8.res,
                 beta.pacs4_v2.res,beta.mrbma.res)
rownames(tbl_res) <- c('IVW','adIVW','IVW-LASSO','MVMR-dLASSO','MVMR-PACS4-0.2','MVMR-PACS4-0.5','MVMR-PACS4-0.8','MVMR-PACS-v2','MR-BMA')
colnames(tbl_res) <- traits
print(round(t(tbl_res),3))
write.csv(round(t(tbl_res),3),'Res/fig 5e-08/main_analysis_090925.csv')
save.image('Res/fig 5e-08/main_analysis_090925.Rdata')
```

For MRMBA, the top 10 models are the follows:

```{r, include=TRUE}
best.model.out = sss.report.best.model(BMA_output, prior_sigma=0.5, top = 10, write.out = FALSE, csv.file.name="amd_best_10models_n145")
print(best.model.out[,-1])
write.csv(print(best.model.out[,-1]),'Res/fig 5e-08/mr.bma.top10.csv')
```

```{r}
set.seed(1234)
pacs4_0.92 <- mvmr_pacs_cv_parallel(beta.exposure = beta.exposure, se.exposure = se.exposure, beta.outcome = beta.outcome, se.outcome = se.outcome, P = P, type = 4, RR_obs = cor(beta.exposure), rr_cut_off = 0.92, betawt = betawt, tau = c(0.5, 1, 2, 3), eps = 1e-3, n_times = 5,lambda.1se = TRUE)

beta.pacs4.0.92.res <- pacs4_0.92$beta
```

```{r}
# inference with signal-clusters
save.image('~/OneDrive - UW/UW biostats/2023-24 RA/MR with highly correlated exposure/manuscript/real data application lipids/results_060225.Rdata')
```

